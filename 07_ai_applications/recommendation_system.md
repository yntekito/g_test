# レコメンデーションシステム（推薦システム）

## 要点
- レコメンデーションシステム（推薦エンジン）は、ユーザーの好みを推測して商品・コンテンツを推薦するシステム。
- 主要手法：**協調フィルタリング**（ユーザー・アイテムの類似度）、**コンテンツベース**（アイテムの特徴）、**ハイブリッド**（両者の組み合わせ）。
- **コールドスタート問題**：新規ユーザー・新規アイテムにはデータがなく推薦が困難。特に協調フィルタリングで顕著。

## 定義
**レコメンデーションシステム（Recommendation System）**は、ユーザーの過去の行動（購買履歴、評価、閲覧履歴等）から好みを予測し、興味を持ちそうな商品・コンテンツを推薦するシステム。ECサイト（Amazon）、動画配信（Netflix）、音楽配信（Spotify）等で広く利用。

## 重要キーワード
- **レコメンデーションエンジン（推薦エンジン）**: ユーザーの好みを推測して推薦するシステム
- **協調フィルタリング（Collaborative Filtering）**: ユーザー・アイテム間の類似度で推薦
- **コンテンツベースフィルタリング（Content-based Filtering）**: アイテムの特徴から推薦
- **ハイブリッド推薦**: 協調フィルタリングとコンテンツベースを組み合わせ
- **コールドスタート問題（Cold Start Problem）**: 新規ユーザー・新規アイテムのデータ不足で推薦困難
- **評価行列（Rating Matrix）**: ユーザー×アイテムの評価データ行列
- **行列因子分解（Matrix Factorization）**: 評価行列を低次元に分解して推薦

---

## 典型的な試験問題（穴埋め）★重要

> 「ユーザーの好みを推測するシステムとして**（A）エンジン**がある。これに用いられる1つの手法として**（B）**があるが、**コールドスタート問題**には注意が必要となる。」

**正解**:
- **(A): レコメンデーション（推薦）**
- **(B): 協調フィルタリング（Collaborative Filtering）**

**解説**:
- レコメンデーションエンジンは、ユーザーの好みを推測して商品・コンテンツを推薦
- 協調フィルタリングは、類似ユーザーの評価から推薦する主要手法
- コールドスタート問題は、新規ユーザー・新規アイテムには評価データがないため推薦できない問題

---

## 主要な推薦手法

### 1. 協調フィルタリング（Collaborative Filtering）

#### 定義
ユーザー間またはアイテム間の類似度を計算し、類似するユーザーが高評価したアイテムを推薦する手法。「似たユーザーは似たアイテムを好む」という前提。

#### 2つのアプローチ

**ユーザーベース協調フィルタリング（User-based CF）**:
- **原理**: 対象ユーザーと類似するユーザーを見つけ、そのユーザーが好むアイテムを推薦
- **プロセス**:
  1. ユーザー間の類似度を計算（コサイン類似度、ピアソン相関等）
  2. 類似度が高いユーザーを選択
  3. そのユーザーが高評価したアイテムを推薦

```
例：
ユーザーA: 映画1★★★★★、映画2★★★★☆、映画3★★☆☆☆
ユーザーB: 映画1★★★★★、映画2★★★★★、映画3★★☆☆☆、映画4★★★★★

→ AとBは似ている（映画1-3の評価が近い）
→ Aには映画4を推薦
```

**アイテムベース協調フィルタリング（Item-based CF）**:
- **原理**: 対象アイテムと類似するアイテムを見つけ、ユーザーが既に好んだアイテムと似たものを推薦
- **プロセス**:
  1. アイテム間の類似度を計算（複数ユーザーの評価パターンから）
  2. ユーザーが高評価したアイテムと類似するアイテムを推薦

```
例：
映画1を高評価したユーザーたち: A, B, C, D
映画2を高評価したユーザーたち: A, B, C, E

→ 映画1と映画2は似ている（評価パターンが近い）
→ 映画1を好きなユーザーには映画2を推薦
```

#### 協調フィルタリングの利点

✅ **主な利点**:
1. **アイテムの内容不要**: 評価データのみで推薦可能
2. **セレンディピティ**: 意外な発見（予想外の好み）を提供
3. **多様性**: 幅広いジャンルを推薦可能
4. **実績あり**: Amazon、Netflix等で実用化

#### 協調フィルタリングの課題

❌ **主な課題**:

**1. コールドスタート問題（Cold Start Problem）**：
- **新規ユーザー**: 評価データがないため推薦不可
- **新規アイテム**: 誰も評価していないため推薦されない
- **対策**: コンテンツベース併用、人気アイテム推薦、初期アンケート

**2. スパースネス問題（Sparsity Problem）**：
- 評価行列が疎（ほとんどが空欄）
- ユーザーは全アイテムの1%未満しか評価しない
- **対策**: 行列因子分解、暗黙的フィードバック利用

**3. スケーラビリティ問題**：
- ユーザー・アイテム数増加で計算量爆発
- **対策**: アイテムベース推薦、近似アルゴリズム

**4. フィルターバブル（Filter Bubble）**：
- 似た嗜好の情報しか推薦されない
- 多様性が失われる
- **対策**: ランダム推薦の混入、多様性重視

#### 類似度の計算方法

**コサイン類似度（Cosine Similarity）**:
$$\text{sim}(u, v) = \frac{\mathbf{r}_u \cdot \mathbf{r}_v}{||\mathbf{r}_u|| \cdot ||\mathbf{r}_v||}$$

- $\mathbf{r}_u$, $\mathbf{r}_v$: ユーザー$u$, $v$の評価ベクトル
- 評価パターンの方向の類似度（0～1、1が最も類似）

**ピアソン相関係数（Pearson Correlation）**:
$$\text{sim}(u, v) = \frac{\sum (r_{ui} - \bar{r}_u)(r_{vi} - \bar{r}_v)}{\sqrt{\sum (r_{ui} - \bar{r}_u)^2} \sqrt{\sum (r_{vi} - \bar{r}_v)^2}}$$

- $r_{ui}$: ユーザー$u$のアイテム$i$への評価
- $\bar{r}_u$: ユーザー$u$の平均評価
- 評価の相関（-1～1、1が最も類似）

### 2. コンテンツベースフィルタリング（Content-based Filtering）

#### 定義
アイテムの特徴（ジャンル、出演者、タグ等）を分析し、ユーザーが過去に好んだアイテムと類似する特徴を持つアイテムを推薦する手法。

#### プロセス

1. **アイテムプロファイル作成**: アイテムの特徴をベクトル化
   - 映画: ジャンル（アクション、SF）、監督、出演者、年代
   - 記事: キーワード、カテゴリ、著者

2. **ユーザープロファイル作成**: ユーザーが好むアイテムの特徴を統合
   - 高評価アイテムの特徴ベクトルの平均

3. **類似度計算**: ユーザープロファイルとアイテムプロファイルの類似度
   - コサイン類似度、TF-IDF等

4. **推薦**: 類似度が高いアイテムを推薦

#### 例

```
ユーザーAが好む映画:
- スターウォーズ: SF、アクション、宇宙
- インターステラー: SF、宇宙
- マトリックス: SF、アクション

→ ユーザープロファイル: SF=3, アクション=2, 宇宙=2

新作映画「ガーディアンズ・オブ・ギャラクシー」:
- SF、アクション、宇宙 → 類似度が高い → 推薦
```

#### コンテンツベースの利点

✅ **主な利点**:
1. **コールドスタート（新規アイテム）に強い**: アイテムの特徴があれば推薦可能
2. **説明可能性**: 「あなたが好きな〇〇に似ています」と理由を説明できる
3. **独立性**: 他ユーザーのデータ不要
4. **新規性**: 未評価の新作も推薦可能

#### コンテンツベースの課題

❌ **主な課題**:
1. **過度な専門化（Over-specialization）**: 似たアイテムしか推薦しない（多様性欠如）
2. **特徴抽出の困難**: 映画の「面白さ」等の抽象的特徴は数値化困難
3. **新規ユーザーには弱い**: 評価データがないと推薦精度低い
4. **スケーラビリティ**: すべてのアイテムの特徴を手動で記述するのは困難

### 3. ハイブリッド推薦（Hybrid Recommendation）

#### 定義
協調フィルタリングとコンテンツベースの両方を組み合わせ、各手法の欠点を補完する推薦手法。

#### 組み合わせ方法

**1. 加重ハイブリッド（Weighted Hybrid）**:
- 両手法のスコアを重み付けして統合
- $\text{Score} = \alpha \times \text{CF} + (1-\alpha) \times \text{CB}$

**2. 切り替えハイブリッド（Switching Hybrid）**:
- 状況に応じて手法を切り替え
- 例: 新規ユーザーはコンテンツベース、既存ユーザーは協調フィルタリング

**3. カスケードハイブリッド（Cascade Hybrid）**:
- 一方の手法で候補を絞り、もう一方で順位付け
- 例: 協調フィルタリングで候補選択 → コンテンツベースで精密化

**4. 特徴統合ハイブリッド（Feature Combination）**:
- 両手法の特徴を機械学習モデルに入力
- 深層学習で統合

#### 利点
- 各手法の利点を活かし、欠点を補完
- 精度・多様性・説明可能性のバランスが良い
- Netflix、Spotifyで実用化

---

## コールドスタート問題（Cold Start Problem）★試験重要

### 定義
新規ユーザーや新規アイテムには十分な評価データがなく、推薦システムが適切な推薦を行えない問題。**協調フィルタリングで特に顕著**。

### 3つのタイプ

**1. 新規ユーザーのコールドスタート**:
- 新規登録ユーザーには評価履歴がない
- 類似ユーザーを見つけられない
- **対策**: 初期アンケート、人気アイテム推薦、コンテンツベース併用

**2. 新規アイテムのコールドスタート**:
- 新作商品・コンテンツには評価がない
- 推薦候補に上がらない
- **対策**: コンテンツベース推薦、編集部おすすめ、ランダム表示

**3. システム全体のコールドスタート**:
- サービス開始直後でデータが不足
- **対策**: 外部データ利用、専門家の推薦、初期ユーザーからの積極的な評価収集

### 対策手法

**1. 初期アンケート・プロファイリング**:
- 新規ユーザーに好みを質問
- 年齢・性別・興味分野等のデモグラフィック情報収集

**2. 人気アイテム推薦**:
- 全ユーザーの評価が高いアイテムを推薦
- ベストセラー、トレンド商品

**3. コンテンツベース併用**:
- アイテムの特徴から推薦
- 評価データ不要

**4. 暗黙的フィードバック利用**:
- 明示的評価（星評価）だけでなく、閲覧履歴・滞在時間・購入履歴を活用
- データ収集が早い

**5. ソーシャル情報利用**:
- SNSの友人関係・フォロー関係を利用
- 友人が好むアイテムを推薦

---

## 行列因子分解（Matrix Factorization）

### 定義
評価行列を低次元の潜在因子に分解し、欠損値（未評価）を予測する手法。協調フィルタリングの高度な実装。

### 基本原理

**評価行列 $R$（ユーザー×アイテム）**:
```
        映画1  映画2  映画3  映画4
ユーザーA  5     3     ?     4
ユーザーB  4     ?     2     ?
ユーザーC  ?     5     4     3
```

**因子分解**:
$$R \approx U \times V^T$$

- $U$: ユーザー×潜在因子（$m \times k$）
- $V$: アイテム×潜在因子（$n \times k$）
- $k$: 潜在因子の次元数（例：10, 50）

**潜在因子の解釈例**:
- 因子1: アクション度
- 因子2: ロマンス度
- 因子3: コメディ度

**予測**:
$$\hat{r}_{ui} = \mathbf{u}_u \cdot \mathbf{v}_i$$

- $\mathbf{u}_u$: ユーザー$u$の潜在ベクトル
- $\mathbf{v}_i$: アイテム$i$の潜在ベクトル

### 学習

**目的関数**（最小化）:
$$\min_{U, V} \sum_{(u,i) \in \text{observed}} (r_{ui} - \mathbf{u}_u \cdot \mathbf{v}_i)^2 + \lambda (||\mathbf{u}_u||^2 + ||\mathbf{v}_i||^2)$$

- 第1項: 予測誤差
- 第2項: 正則化項（過学習防止）

**最適化**:
- 確率的勾配降下法（SGD）
- 交互最小二乗法（ALS）

### 利点
- スパースな評価行列でも高精度
- 計算効率が良い
- Netflix Prize（2006-2009）で注目

---

## 深層学習ベースの推薦システム

### 代表的手法

**1. ニューラル協調フィルタリング（Neural CF）**:
- ユーザー・アイテムの埋め込みをニューラルネットワークで学習
- 非線形な相互作用を捉える

**2. オートエンコーダベース（AutoRec）**:
- 評価ベクトルをオートエンコーダで圧縮・復元
- 欠損値を補完

**3. RNNベース**:
- ユーザーの行動履歴を時系列として扱う
- 次に見るアイテムを予測

**4. Transformer/BERTベース**:
- Self-Attentionでユーザー行動のパターン学習
- BERT4Rec等

**5. グラフニューラルネットワーク（GNN）**:
- ユーザー・アイテムをグラフ構造で表現
- 関係性を学習

### 利点
- 複雑なパターン学習
- マルチモーダル情報統合（画像、テキスト、メタデータ）
- 説明性の向上（Attention可視化）

---

## 評価指標

### 精度指標

**1. 平均絶対誤差（MAE: Mean Absolute Error）**:
$$\text{MAE} = \frac{1}{N} \sum_{i=1}^N |r_i - \hat{r}_i|$$

**2. 平均二乗誤差（RMSE: Root Mean Squared Error）**:
$$\text{RMSE} = \sqrt{\frac{1}{N} \sum_{i=1}^N (r_i - \hat{r}_i)^2}$$

**3. 適合率・再現率（Precision, Recall）**:
- Precision: 推薦したアイテムのうち正解の割合
- Recall: 正解のうち推薦できた割合

**4. MAP（Mean Average Precision）**:
- ランキングの精度評価

**5. NDCG（Normalized Discounted Cumulative Gain）**:
- ランキング上位の正確性を重視

### ビジネス指標

- **クリック率（CTR: Click-Through Rate）**
- **コンバージョン率（CVR: Conversion Rate）**
- **収益（Revenue）**
- **ユーザー満足度（Satisfaction）**
- **滞在時間（Engagement）**

---

## 試験での問われ方

### 典型設問

**穴埋め問題**:
> 「ユーザーの好みを推測するシステムとして**（レコメンデーション）エンジン**がある。これに用いられる1つの手法として**（協調フィルタリング）**があるが、**コールドスタート問題**には注意が必要となる。」

**選択問題**:
- 「協調フィルタリングの課題として最も適切なものは？」
  - ✅ コールドスタート問題、スパースネス問題
  - ❌ 計算量が少ない、説明可能性が高い

- 「新規ユーザーへの推薦に適した手法は？」
  - ✅ コンテンツベースフィルタリング、人気アイテム推薦
  - ❌ 協調フィルタリング（データ不足）

- 「ユーザー間の類似度を利用する手法は？」
  - ✅ 協調フィルタリング
  - ❌ コンテンツベースフィルタリング

### 引っ掛けポイント

| ひっかけ | 正しい理解 |
|----------|------------|
| ❌ 協調フィルタリングは新規ユーザーに強い | ✅ コールドスタート問題で弱い |
| ❌ コンテンツベースは多様性が高い | ✅ 似たアイテムしか推薦しない（過度な専門化） |
| ❌ レコメンデーションは常に精度重視 | ✅ 多様性・セレンディピティも重要 |
| ❌ 協調フィルタリングはアイテムの特徴が必要 | ✅ 評価データのみで推薦可能 |

### 比較されやすい概念

**協調フィルタリング vs コンテンツベース**:

| 項目 | 協調フィルタリング | コンテンツベース |
|------|-----------------|----------------|
| **データ** | ユーザー評価 | アイテム特徴 |
| **類似度** | ユーザー・アイテム間 | アイテム特徴間 |
| **コールドスタート** | **弱い**（新規は困難） | **強い**（特徴があればOK） |
| **多様性** | 高い（意外な発見） | **低い**（似たものばかり） |
| **説明可能性** | 低い | **高い**（特徴で説明） |
| **実装** | 比較的容易 | 特徴設計が必要 |

**ユーザーベース vs アイテムベース**:

| 項目 | ユーザーベースCF | アイテムベースCF |
|------|---------------|----------------|
| **類似度計算** | ユーザー間 | アイテム間 |
| **スケーラビリティ** | 低い（ユーザー数増加） | **高い**（アイテム数は安定） |
| **精度** | 高い（類似ユーザー） | 高い（類似アイテム） |
| **更新頻度** | 高い（ユーザー増加） | **低い**（アイテムは固定的） |
| **実用** | 初期の手法 | **現代の標準**（Amazon等） |

---

## 補足

### 実務的観点

**代表的サービス**:
- **Amazon**: アイテムベース協調フィルタリング「この商品を買った人はこんな商品も買っています」
- **Netflix**: ハイブリッド推薦、行列因子分解、深層学習
- **YouTube**: 深層学習ベース、視聴履歴・滞在時間を重視
- **Spotify**: 協調フィルタリング + 音響特徴分析
- **楽天**: 購買履歴ベースの協調フィルタリング

**推薦システムの課題**:
1. **フィルターバブル**: 似た情報ばかり推薦される問題
2. **プライバシー**: 行動データの収集・利用
3. **公平性**: 特定グループへの偏り
4. **説明責任**: なぜこれを推薦したか説明困難
5. **操作**: レビュー操作・評価操作への対策

**A/Bテスト**:
- 複数の推薦アルゴリズムを比較
- CTR、CVR、収益で評価
- 継続的な改善

### 発展

**最新動向**:
- **Transformer/BERTベース**: BERT4Rec、SASRec
- **グラフニューラルネットワーク**: PinSage（Pinterest）
- **強化学習**: 長期的なユーザー満足度最大化
- **因果推論**: 推薦の因果効果を評価
- **マルチモーダル**: テキスト・画像・動画を統合

### 関連トピック
- [教師なし学習](../05_machine_learning/unsupervised_learning.md) - クラスタリング、次元削減
- [深層学習](../06_deep_learning/neural_network_basics.md) - 深層学習ベースの推薦
- [自然言語処理](natural_language_processing.md) - テキストベースの推薦
- [倫理](../09_law_ethics/ai_ethics_principles.md) - フィルターバブル、プライバシー
